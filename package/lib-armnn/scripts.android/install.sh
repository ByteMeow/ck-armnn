#!/bin/bash

ARMNN_SOURCE_DIR=$INSTALL_DIR/$PACKAGE_SUB_DIR
ARMNN_BUILD_DIR=$INSTALL_DIR/obj
export ARMNN_TARGET_DIR=$INSTALL_DIR/install
STANDALONE_TOOLCHAIN_DIR=$INSTALL_DIR/standalone_toolchain

if [ "$USE_TFLITE" == "YES" ] || [ "$USE_TFLITE" == "yes" ] || [ "$USE_TFLITE" == "ON" ] || [ "$USE_TFLITE" == "on" ] || [ "$USE_TFLITE" == "1" ]
then
    CMAKE_FOR_TFLITE=" -DBUILD_TF_LITE_PARSER=1 -DTF_LITE_GENERATED_PATH=${CK_ENV_LIB_TF_SRC_SRC}/tensorflow/lite/schema -DFLATBUFFERS_ROOT=${CK_ENV_LIB_FLATBUFFERS} -DFLATBUFFERS_LIBRARY=${CK_ENV_LIB_FLATBUFFERS_LIB}/libflatbuffers.a "
else
    CMAKE_FOR_TFLITE=""
fi

# build the standalone toolchain:
${CK_ANDROID_NDK_ROOT_DIR}/build/tools/make_standalone_toolchain.py \
    --arch ${CK_ANDROID_NDK_ARCH} \
    --api ${CK_ANDROID_API_LEVEL} \
    --stl=libc++ \
    --install-dir ${STANDALONE_TOOLCHAIN_DIR}

rm -rf "${ARMNN_BUILD_DIR}"
mkdir ${ARMNN_BUILD_DIR}
cd ${ARMNN_BUILD_DIR}

BOOST_INCLUDEDIR="${CK_ENV_LIB_BOOST_INCLUDE}" \
BOOST_LIBRARYDIR="${CK_ENV_LIB_BOOST_LIB}" \
BOOST_ROOT=${CK_ENV_LIB_BOOST} \
cmake ${ARMNN_SOURCE_DIR} \
    -DCMAKE_SYSTEM_NAME=Android \
    -DCMAKE_ANDROID_ARCH_ABI=${CK_ANDROID_ABI} \
    -DCMAKE_ANDROID_STANDALONE_TOOLCHAIN=${STANDALONE_TOOLCHAIN_DIR} \
    -DCMAKE_CXX_FLAGS="-fPIE -fPIC" \
    -DCMAKE_EXE_LINKER_FLAGS="-shared -llog" \
    ${CMAKE_FOR_TFLITE} \
    -DCMAKE_INSTALL_PREFIX:PATH="${ARMNN_TARGET_DIR}" \
    -DCMAKE_VERBOSE_MAKEFILE=NO

    #-DBUILD_UNIT_TESTS=NO \

    #-DCMAKE_CXX_FLAGS="-fPIE -fPIC" \
    #-DCMAKE_EXE_LINKER_FLAGS="-pie -llog" \
    
    #-DCMAKE_EXE_LINKER_FLAGS="${CK_LINKER_FLAGS_ANDROID_TYPICAL}" \
    #-DCMAKE_EXE_LINKER_LIBS="${CK_LINKER_LIBS_ANDROID_TYPICAL}" \
    #-DCMAKE_BUILD_TYPE=${CK_ENV_CMAKE_BUILD_TYPE:-Release} \
    #-DCMAKE_C_COMPILER="${CK_CC_PATH_FOR_CMAKE}" \
    #-DCMAKE_C_FLAGS="${CK_CC_FLAGS_FOR_CMAKE} ${CK_CC_FLAGS_ANDROID_TYPICAL} ${EXTRA_FLAGS}" \
    #-DCMAKE_CXX_COMPILER="${CK_CXX_PATH_FOR_CMAKE}" \
    #-DCMAKE_CXX_FLAGS="${CK_CXX_FLAGS_FOR_CMAKE} ${CK_CXX_FLAGS_ANDROID_TYPICAL} ${EXTRA_FLAGS}" \
    #-DCMAKE_AR="${CK_AR_PATH_FOR_CMAKE}" \
    #-DCMAKE_LINKER="${CK_LD_PATH_FOR_CMAKE}" \
    #-DCMAKE_SHARED_LINKER_FLAGS="${CK_OPENMP}" \

    #-DBoost_VERSION=106400 \
    #-DBoost_ADDITIONAL_VERSIONS="1.64" \
    #-DBoost_NO_SYSTEM_PATHS=ON \
    #-DBoost_INCLUDE_DIR:PATH="${CK_ENV_LIB_BOOST_INCLUDE}" \
    #-DBoost_LIBRARY_DIR:PATH="${CK_ENV_LIB_BOOST_LIB}" \
    #-DBoost_USE_STATIC_LIBS=OFF \

    #-DCMAKE_CROSSCOMPILING="TRUE" \
    #-DCMAKE_HOST_SYSTEM_NAME="${HOST_OS}" \
    #-DBoost_NO_BOOST_CMAKE=ON \